<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ² è€é ‘ç«¥å®¶æ— æ–éª°å­</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=ZCOOL+KuaiLe&display=swap');

:root {
  --red: #C41E1E;
  --red-dark: #7A0000;
  --red-deep: #520000;
  --gold: #F0C040;
  --gold-bright: #FFD700;
  --gold-dim: #B8860B;
  --cream: #FFF8E8;
  --cream-dark: #F5E6C8;
  --ink: #1A0505;
  --green: #4CAF50;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans TC', sans-serif;
  background: var(--red-deep);
  color: var(--cream);
  min-height: 100vh;
  position: relative;
}

/* Background */
.bg {
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse at 30% 20%, rgba(240,192,64,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 80%, rgba(196,30,30,0.15) 0%, transparent 40%),
    linear-gradient(175deg, #520000 0%, #7A0000 35%, #520000 70%, #3A0000 100%);
}

.screen { display: none; position: relative; z-index: 1; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* ========== LOGIN ========== */
#loginScreen { align-items: center; justify-content: center; padding: 30px 20px; }

.login-card {
  background: linear-gradient(160deg, rgba(255,248,232,0.96), rgba(245,230,200,0.93));
  border: 3px solid var(--gold);
  border-radius: 24px;
  padding: 36px 28px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 8px 60px rgba(0,0,0,0.4);
  color: var(--ink);
  animation: cardUp 0.7s ease-out;
}

@keyframes cardUp { from { opacity:0; transform: translateY(40px); } to { opacity:1; transform: translateY(0); } }

.login-header { font-size: 3rem; text-align: center; margin-bottom: 8px; }
.login-title { font-family: 'ZCOOL KuaiLe', cursive; font-size: 2rem; color: var(--red); text-align: center; margin-bottom: 6px; }
.login-sub { font-size: 0.82rem; color: var(--red-dark); opacity: 0.65; text-align: center; margin-bottom: 24px; }

.input-group { margin-bottom: 14px; }
.input-group label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--red-dark); margin-bottom: 5px; opacity: 0.8; }
.input-group input {
  width: 100%; padding: 13px 15px;
  border: 2px solid rgba(196,30,30,0.18);
  border-radius: 13px;
  font-family: 'Noto Sans TC', sans-serif; font-size: 1.05rem;
  background: rgba(255,255,255,0.7); color: var(--ink);
  outline: none;
}
.input-group input:focus { border-color: var(--gold); }

.login-btn {
  width: 100%; padding: 15px;
  background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
  color: var(--gold-bright); border: 2px solid var(--gold);
  border-radius: 16px;
  font-family: 'ZCOOL KuaiLe', cursive; font-size: 1.25rem;
  cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 20px rgba(122,0,0,0.3);
  margin-top: 6px;
}
.login-btn:hover { transform: translateY(-2px); }
.login-btn:active { transform: scale(0.97); }
.login-btn.secondary {
  background: rgba(255,255,255,0.6);
  color: var(--red-dark);
  font-size: 1rem;
  padding: 12px;
  box-shadow: 0 2px 12px rgba(122,0,0,0.15);
  margin-top: 10px;
}

.room-code-display {
  background: rgba(240,192,64,0.15);
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 12px;
  margin: 16px 0;
  text-align: center;
}
.room-code-display .label { font-size: 0.7rem; color: var(--red-dark); opacity: 0.7; margin-bottom: 4px; }
.room-code-display .code { font-family: 'ZCOOL KuaiLe', cursive; font-size: 1.8rem; color: var(--red); letter-spacing: 4px; }

/* ========== GAME ========== */
#gameScreen { padding: 20px; }

.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 12px 16px;
  background: rgba(0,0,0,0.3);
  border-radius: 16px;
}

.top-title { font-family: 'ZCOOL KuaiLe', cursive; font-size: 1.5rem; color: var(--gold); }
.top-info { font-size: 0.8rem; color: var(--gold-dim); margin-top: 4px; }

.btn-sm {
  padding: 8px 16px;
  border: 2px solid var(--gold);
  border-radius: 20px;
  background: var(--glass);
  color: var(--gold);
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-sm:hover { background: rgba(240,192,64,0.2); }

/* Dice Animation Overlay */
.dice-animation-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  z-index: 999;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s;
}

.dice-animation-overlay.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.dice-animation-content {
  text-align: center;
}

.dice-animation-title {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 2rem;
  color: var(--gold);
  margin-bottom: 30px;
  text-shadow: 0 0 20px rgba(240,192,64,0.5);
}

.dice-big-container {
  display: flex;
  gap: 30px;
  justify-content: center;
  align-items: center;
}

.die-big {
  width: 120px;
  height: 120px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  padding: 16px;
  gap: 8px;
  animation: diceAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes diceAppear {
  from {
    opacity: 0;
    transform: scale(0.5) rotate(-180deg);
  }
  to {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
}

.die-big .dot {
  width: 16px;
  height: 16px;
}

/* Dice Cup Container */
.dice-cup-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 20px 0;
}

.dice-cup {
  width: 200px;
  height: 200px;
  position: relative;
  margin-bottom: 20px;
}

.cup {
  width: 180px;
  height: 180px;
  background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
  border-radius: 50% 50% 45% 45%;
  position: absolute;
  top: 10px;
  left: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5), inset 0 -10px 20px rgba(0,0,0,0.3);
  border: 4px solid #5D3A1A;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.cup.shaking {
  animation: shake 0.5s infinite;
}

@keyframes shake {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-5deg) translateY(-5px); }
  75% { transform: rotate(5deg) translateY(-5px); }
}

.dice-result {
  display: flex;
  gap: 15px;
  margin-top: 120px;
}

.die {
  width: 60px;
  height: 60px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  padding: 8px;
  gap: 4px;
}

.die.hidden { display: none; }

.dot {
  width: 8px;
  height: 8px;
  background: var(--red-dark);
  border-radius: 50%;
}

/* Timer */
.timer-section {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: rgba(0,0,0,0.3);
  border-radius: 16px;
}

.timer-label { font-size: 0.9rem; color: var(--gold-dim); margin-bottom: 5px; }
.timer-value {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 2.5rem;
  color: var(--gold);
}
.timer-value.warning { color: #FF5722; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Betting Table */
.betting-table {
  background: linear-gradient(155deg, rgba(34,139,34,0.95), rgba(0,100,0,0.95));
  border: 4px solid var(--gold);
  border-radius: 20px;
  padding: 20px;
  margin: 20px 0;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
}

.betting-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.bet-spot {
  aspect-ratio: 1;
  background: rgba(255,255,255,0.1);
  border: 3px solid var(--gold-dim);
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: all 0.3s;
  cursor: pointer;
}

.bet-spot:hover {
  background: rgba(255,255,255,0.2);
  border-color: var(--gold);
  transform: scale(1.02);
}

.bet-spot.has-my-bet {
  background: rgba(76,175,80,0.2);
  border-color: var(--green);
}

.bet-spot.winner {
  background: rgba(255,215,0,0.3);
  border-color: var(--gold-bright);
  animation: winPulse 1s infinite;
}

.my-bet-on-spot {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--green);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

@keyframes winPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.bet-number {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 3rem;
  color: var(--gold);
  margin-bottom: 10px;
}

.bets-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 80px;
  overflow-y: auto;
  width: 100%;
  padding: 0 8px;
}

.bets-list::-webkit-scrollbar { width: 4px; }
.bets-list::-webkit-scrollbar-thumb { background: rgba(240,192,64,0.5); border-radius: 4px; }

.bet-item {
  background: rgba(0,0,0,0.4);
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bet-player { color: var(--cream); font-weight: 700; }
.bet-amount { color: var(--gold); }

/* Player Betting Panel */
.betting-panel {
  background: linear-gradient(160deg, rgba(255,248,232,0.96), rgba(245,230,200,0.93));
  border: 3px solid var(--gold);
  border-radius: 20px;
  padding: 20px;
  margin: 20px 0;
  color: var(--ink);
}

.panel-title {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 1.3rem;
  color: var(--red);
  text-align: center;
  margin-bottom: 15px;
}

.chip-select {
  margin-bottom: 20px;
}

.chip-label {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--red-dark);
  margin-bottom: 10px;
  text-align: center;
}

.chip-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}

.chip-btn {
  padding: 12px 8px;
  background: rgba(255,255,255,0.7);
  border: 3px solid rgba(196,30,30,0.2);
  border-radius: 50%;
  aspect-ratio: 1;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--red-dark);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chip-btn:hover {
  background: rgba(240,192,64,0.3);
  border-color: var(--gold);
}

.chip-btn.selected {
  background: linear-gradient(135deg, var(--gold), var(--gold-dim));
  color: var(--red-deep);
  border-color: var(--red);
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(240,192,64,0.5);
}

.betting-instruction {
  text-align: center;
  font-size: 0.85rem;
  color: var(--red-dark);
  margin: 15px 0;
  padding: 10px;
  background: rgba(240,192,64,0.1);
  border-radius: 10px;
}

.my-bets-summary {
  background: rgba(76,175,80,0.1);
  border: 2px solid var(--green);
  border-radius: 12px;
  padding: 12px;
  margin: 15px 0;
}

.my-bets-title {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--green);
  margin-bottom: 8px;
  text-align: center;
}

.my-bets-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.my-bet-item {
  background: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
  border: 2px solid var(--green);
}

.my-bet-number {
  color: var(--red);
}

.my-bet-amount {
  color: var(--green);
}

.betting-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 15px;
}

.confirm-bet-btn, .reset-bet-btn {
  padding: 15px;
  border: 2px solid;
  border-radius: 16px;
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.2s;
}

.confirm-bet-btn {
  background: linear-gradient(135deg, var(--green), #2E7D32);
  color: white;
  border-color: #1B5E20;
}

.confirm-bet-btn:hover { transform: translateY(-2px); }
.confirm-bet-btn:disabled {
  background: #ccc;
  color: #666;
  cursor: not-allowed;
  transform: none;
  border-color: #999;
}

.reset-bet-btn {
  background: rgba(255,255,255,0.7);
  color: var(--red);
  border-color: var(--red);
}

.reset-bet-btn:hover {
  background: rgba(255,255,255,0.9);
  transform: translateY(-2px);
}

/* Result Panel */
.result-panel {
  background: linear-gradient(160deg, rgba(255,248,232,0.96), rgba(245,230,200,0.93));
  border: 3px solid var(--gold);
  border-radius: 20px;
  padding: 24px;
  margin: 20px 0;
  color: var(--ink);
  text-align: center;
}

.result-title {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 1.8rem;
  color: var(--red);
  margin-bottom: 15px;
}

.result-item {
  background: rgba(0,0,0,0.05);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.result-player { font-weight: 700; color: var(--red-dark); }
.result-outcome { font-weight: 700; }
.result-outcome.win { color: var(--green); }
.result-outcome.lose { color: #888; }

/* Toast */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: var(--gold);
  color: var(--red-deep);
  padding: 12px 24px;
  border-radius: 30px;
  font-weight: 700;
  font-size: 0.9rem;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

@media (min-width: 600px) {
  #gameScreen {
    max-width: 600px;
    margin: 0 auto;
  }
}
</style>
</head>
<body>

<div class="bg"></div>

<!-- ======== LOGIN ======== -->
<div class="screen active" id="loginScreen">
  <div class="login-card">
    <div class="login-header">ğŸ²</div>
    <div class="login-title">æ–éª°å­</div>
    <div class="login-sub">æŠ¼é»æ•¸ï¼Œæ–éª°å­ï¼Œä¸­ä¸€é¡†è³ºä¸€å€ï¼</div>

    <!-- Create/Join Toggle -->
    <div id="createPanel">
      <div class="input-group">
        <label>ğŸ‘¤ èŠå®¶åå­—</label>
        <input type="text" id="bankerNameInput" placeholder="ä¾‹ï¼šçˆ¸çˆ¸" autocomplete="off">
      </div>
      <button class="login-btn" onclick="createRoom()">ğŸ° å»ºç«‹æˆ¿é–“</button>
      <button class="login-btn secondary" onclick="showJoinPanel()">ğŸšª åŠ å…¥æˆ¿é–“</button>
    </div>

    <div id="joinPanel" style="display:none;">
      <div class="input-group">
        <label>ğŸ¯ æˆ¿é–“ç¢¼</label>
        <input type="text" id="roomCodeInput" placeholder="è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" maxlength="6" inputmode="numeric" pattern="[0-9]*">
      </div>
      <div class="input-group">
        <label>ğŸ‘¤ ä½ çš„åå­—</label>
        <input type="text" id="playerNameInput" placeholder="ä¾‹ï¼šåª½åª½">
      </div>
      <button class="login-btn" onclick="joinRoom()">ğŸš€ åŠ å…¥éŠæˆ²</button>
      <button class="login-btn secondary" onclick="showCreatePanel()">â† è¿”å›</button>
    </div>

    <div id="waitingPanel" style="display:none;">
      <div class="room-code-display">
        <div class="label">é©—è­‰ç¢¼</div>
        <div class="code" id="displayRoomCode"></div>
      </div>
      <div style="text-align:center; font-size:0.85rem; color: var(--red-dark); margin: 15px 0;">
        ç­‰å¾…ç©å®¶åŠ å…¥...
      </div>
    </div>
  </div>
</div>

<!-- ======== GAME ======== -->
<div class="screen" id="gameScreen">
  <div class="top-bar">
    <div>
      <div class="top-title">ğŸ² æ–éª°å­</div>
      <div class="top-info" id="topInfo">æˆ¿é–“: <span id="roomCodeDisplay"></span></div>
    </div>
    <button class="btn-sm" onclick="backToLogin()">é›¢é–‹</button>
  </div>

  <!-- Timer -->
  <div class="timer-section" id="timerSection">
    <div class="timer-label" id="timerLabel">ä¸‹æ³¨æ™‚é–“</div>
    <div class="timer-value" id="timerValue">120</div>
  </div>

  <!-- Dice Cup (Banker View) -->
  <div class="dice-cup-container" id="diceCupContainer" style="display:none;">
    <div class="dice-cup">
      <div class="cup" id="cup">
        <span style="font-size:3rem;">ğŸ²</span>
      </div>
    </div>
    <div class="dice-result" id="diceResult"></div>
  </div>

  <!-- Betting Table -->
  <div class="betting-table">
    <div class="betting-grid" id="bettingGrid">
      <!-- Will be filled by JS -->
    </div>
  </div>

  <!-- Player Betting Panel -->
  <div class="betting-panel" id="bettingPanel" style="display:none;">
    <div class="panel-title">ä¸‹æ³¨å€</div>

    <div class="chip-select">
      <div class="chip-label">é¸æ“‡ç±Œç¢¼</div>
      <div class="chip-buttons" id="chipButtons">
        <!-- Will be filled by JS -->
      </div>
    </div>

    <div class="betting-instruction">
      ğŸ’¡ é¸æ“‡ç±Œç¢¼å¾Œï¼Œé»æ“Šè³­æ¡Œä¸Šçš„æ•¸å­—ä¸‹æ³¨
    </div>

    <div class="my-bets-summary" id="myBetsSummary" style="display:none;">
      <div class="my-bets-title">ğŸ“‹ æˆ‘çš„ä¸‹æ³¨</div>
      <div class="my-bets-list" id="myBetsList"></div>
    </div>

    <div class="betting-actions">
      <button class="reset-bet-btn" onclick="resetMyBets()">
        ğŸ”„ é‡ç½®
      </button>
      <button class="confirm-bet-btn" id="confirmBetBtn" onclick="confirmBet()" disabled>
        âœ… ç¢ºèª
      </button>
    </div>
  </div>

  <!-- Banker Controls -->
  <div id="bankerControls" style="display:none; text-align:center; margin: 20px 0;">
    <button class="login-btn" onclick="startGame()" id="startGameBtn">
      ğŸ¯ é–‹å§‹éŠæˆ²
    </button>
    <button class="login-btn" onclick="endBetting()" id="endBettingBtn" style="display:none;">
      â­ï¸ çµæŸä¸‹æ³¨
    </button>
    <button class="login-btn" onclick="rollDice()" id="rollDiceBtn" style="display:none;">
      ğŸ² æ–éª°å­
    </button>
    <button class="login-btn" onclick="nextRound()" id="nextRoundBtn" style="display:none;">
      â–¶ï¸ ä¸‹ä¸€å±€
    </button>
  </div>

  <!-- Result Panel -->
  <div class="result-panel" id="resultPanel" style="display:none;">
    <div class="result-title">æœ¬å±€çµæœ</div>
    <div id="resultList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Dice Animation Overlay (for all players) -->
<div class="dice-animation-overlay" id="diceAnimationOverlay">
  <div class="dice-animation-content">
    <div class="dice-animation-title">ğŸ² é–‹çä¸­...</div>
    <div class="dice-big-container" id="diceBigContainer">
      <!-- Will be filled by JS -->
    </div>
  </div>
</div>

<script>
// Firebase config (same as bingo game)
const firebaseConfig = {
  apiKey: "AIzaSyBY7jEge0qqyJTox8gDcQcBgMCw2WyQgy8",
  authDomain: "cny-bingo.firebaseapp.com",
  databaseURL: "https://cny-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cny-bingo",
  storageBucket: "cny-bingo.firebasestorage.app",
  messagingSenderId: "483196851206",
  appId: "1:483196851206:web:891fad23ced5450c939f87"
};

let db = null;
let currentRoomRef = null;
let currentRoomCode = null;
let isBanker = false;
let myName = '';
let gameState = 'waiting'; // waiting, betting, rolling, result

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('ğŸ”¥ Firebase initialized');
} catch (e) {
  console.error('Firebase error:', e);
  alert('Firebase é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š');
}

// Generate room code
function generateRoomCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Create room
async function createRoom() {
  const bankerName = document.getElementById('bankerNameInput').value.trim();
  if (!bankerName) {
    showToast('è«‹è¼¸å…¥èŠå®¶åå­—');
    return;
  }

  currentRoomCode = generateRoomCode();
  currentRoomRef = db.ref('diceRooms/' + currentRoomCode);
  isBanker = true;
  myName = bankerName;

  await currentRoomRef.set({
    banker: bankerName,
    players: {},
    bets: {},
    gameState: 'waiting',
    timer: 120,
    diceResult: null,
    createdAt: Date.now()
  });

  listenToRoom();
  startGameView();
  showToast('æˆ¿é–“å·²å»ºç«‹ï¼');
}

function showJoinPanel() {
  document.getElementById('createPanel').style.display = 'none';
  document.getElementById('joinPanel').style.display = 'block';
}

function showCreatePanel() {
  document.getElementById('joinPanel').style.display = 'none';
  document.getElementById('createPanel').style.display = 'block';
}

// Join room
async function joinRoom() {
  const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  const playerName = document.getElementById('playerNameInput').value.trim();

  if (!roomCode || roomCode.length !== 6) {
    showToast('è«‹è¼¸å…¥ 6 ä½æ•¸æˆ¿é–“ç¢¼');
    return;
  }

  if (!playerName) {
    showToast('è«‹è¼¸å…¥ä½ çš„åå­—');
    return;
  }

  currentRoomCode = roomCode;
  currentRoomRef = db.ref('diceRooms/' + currentRoomCode);
  isBanker = false;
  myName = playerName;

  const snapshot = await currentRoomRef.once('value');
  if (!snapshot.exists()) {
    showToast('æˆ¿é–“ä¸å­˜åœ¨');
    return;
  }

  const roomData = snapshot.val();
  if (roomData.players && roomData.players[playerName]) {
    showToast('åå­—å·²è¢«ä½¿ç”¨');
    return;
  }

  await currentRoomRef.child('players').child(playerName).set({
    name: playerName,
    joinedAt: Date.now()
  });

  listenToRoom();
  startGameView();
}

// Listen to room updates
function listenToRoom() {
  currentRoomRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    gameState = data.gameState || 'waiting';

    // Update UI based on game state
    updateGameUI(data);
  });
}

function startGameView() {
  document.getElementById('loginScreen').classList.remove('active');
  document.getElementById('gameScreen').classList.add('active');
  document.getElementById('roomCodeDisplay').textContent = currentRoomCode;

  initializeBettingTable();

  if (isBanker) {
    document.getElementById('diceCupContainer').style.display = 'flex';
    document.getElementById('bankerControls').style.display = 'block';
  } else {
    document.getElementById('bettingPanel').style.display = 'block';
    initializeBettingControls();
  }
}

function initializeBettingTable() {
  const grid = document.getElementById('bettingGrid');
  grid.innerHTML = '';

  for (let i = 1; i <= 6; i++) {
    const spot = document.createElement('div');
    spot.className = 'bet-spot';
    spot.id = 'betSpot' + i;
    spot.onclick = () => placeBetOnNumber(i);
    spot.innerHTML = `
      <div class="bet-number">${i}</div>
      <div class="bets-list" id="betsList${i}"></div>
    `;
    grid.appendChild(spot);
  }
}

function initializeBettingControls() {
  // Chip buttons
  const chipButtons = document.getElementById('chipButtons');
  chipButtons.innerHTML = '';
  [10, 20, 30, 40, 50].forEach(amount => {
    const btn = document.createElement('button');
    btn.className = 'chip-btn';
    btn.textContent = amount;
    btn.onclick = () => selectChip(amount);
    btn.id = 'chipBtn' + amount;
    chipButtons.appendChild(btn);
  });
}

let selectedChip = null;
let myBets = {}; // { number: amount }

function selectChip(amount) {
  selectedChip = amount;
  document.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById('chipBtn' + amount).classList.add('selected');
}

function placeBetOnNumber(number) {
  if (!selectedChip) {
    showToast('è«‹å…ˆé¸æ“‡ç±Œç¢¼é‡‘é¡');
    return;
  }

  if (gameState !== 'betting') {
    showToast('ç›®å‰ç„¡æ³•ä¸‹æ³¨');
    return;
  }

  // Add or accumulate bet
  if (myBets[number]) {
    myBets[number] += selectedChip;
  } else {
    myBets[number] = selectedChip;
  }

  updateMyBetsDisplay();
  showToast(`åœ¨ ${number} é»åŠ æ³¨ \$${selectedChip}`);
}

function updateMyBetsDisplay() {
  const summary = document.getElementById('myBetsSummary');
  const list = document.getElementById('myBetsList');

  if (Object.keys(myBets).length === 0) {
    summary.style.display = 'none';
    document.getElementById('confirmBetBtn').disabled = true;

    // Remove highlights from spots
    for (let i = 1; i <= 6; i++) {
      const spot = document.getElementById('betSpot' + i);
      spot.classList.remove('has-my-bet');
      const existing = spot.querySelector('.my-bet-on-spot');
      if (existing) existing.remove();
    }
    return;
  }

  summary.style.display = 'block';
  document.getElementById('confirmBetBtn').disabled = false;

  // Update list
  list.innerHTML = Object.entries(myBets).map(([num, amt]) =>
    `<div class="my-bet-item">
      <span class="my-bet-number">${num}é»</span>:
      <span class="my-bet-amount">\$${amt}</span>
    </div>`
  ).join('');

  // Highlight spots with bets
  for (let i = 1; i <= 6; i++) {
    const spot = document.getElementById('betSpot' + i);
    const existing = spot.querySelector('.my-bet-on-spot');
    if (existing) existing.remove();

    if (myBets[i]) {
      spot.classList.add('has-my-bet');
      const badge = document.createElement('div');
      badge.className = 'my-bet-on-spot';
      badge.textContent = '\$' + myBets[i];
      spot.appendChild(badge);
    } else {
      spot.classList.remove('has-my-bet');
    }
  }
}

function resetMyBets() {
  myBets = {};
  updateMyBetsDisplay();
  showToast('å·²é‡ç½®ä¸‹æ³¨');
}

async function confirmBet() {
  if (Object.keys(myBets).length === 0) return;

  // Save bets to Firebase
  await currentRoomRef.child('bets').child(myName).set(myBets);

  const total = Object.values(myBets).reduce((sum, amt) => sum + amt, 0);
  showToast(`å·²ç¢ºèªä¸‹æ³¨ï¼Œç¸½é‡‘é¡ \$${total}`);
  document.getElementById('bettingPanel').style.display = 'none';
}

// Banker starts game
async function startGame() {
  await currentRoomRef.update({
    gameState: 'betting',
    timer: 120,
    diceResult: null,
    bets: {}
  });

  document.getElementById('startGameBtn').style.display = 'none';
  document.getElementById('endBettingBtn').style.display = 'block';
}

// Banker ends betting early
async function endBetting() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  await currentRoomRef.update({ gameState: 'rolling' });
  document.getElementById('endBettingBtn').style.display = 'none';
}

let timerInterval = null;

function startTimer(seconds) {
  let remaining = seconds;
  const timerValue = document.getElementById('timerValue');
  const timerLabel = document.getElementById('timerLabel');

  timerLabel.textContent = 'ä¸‹æ³¨æ™‚é–“';
  timerValue.style.fontSize = '2.5rem';

  timerInterval = setInterval(async () => {
    remaining--;
    timerValue.textContent = remaining;

    if (remaining <= 10) {
      timerValue.classList.add('warning');
    } else {
      timerValue.classList.remove('warning');
    }

    if (remaining <= 0) {
      clearInterval(timerInterval);
      if (isBanker) {
        await currentRoomRef.update({ gameState: 'rolling' });
      }
    }
  }, 1000);
}

// Roll dice (only banker calls this)
async function rollDice() {
  document.getElementById('rollDiceBtn').style.display = 'none';

  // Generate final result
  const dice1 = Math.floor(Math.random() * 6) + 1;
  const dice2 = Math.floor(Math.random() * 6) + 1;

  // Update to rolling state (triggers animation for all)
  await currentRoomRef.update({
    gameState: 'rollingAnimation',
    diceResult: [dice1, dice2]
  });

  // After animation duration, change to result state
  setTimeout(async () => {
    await currentRoomRef.update({
      gameState: 'result'
    });
  }, 4000);
}

// Show dice animation overlay (for all players)
function showDiceAnimation(finalDice1, finalDice2) {
  const overlay = document.getElementById('diceAnimationOverlay');
  const container = document.getElementById('diceBigContainer');
  const title = document.querySelector('.dice-animation-title');

  overlay.classList.add('active');
  title.textContent = 'ğŸ² é–‹çä¸­...';

  let elapsed = 0;
  let interval = 100; // Start fast

  const animationInterval = setInterval(() => {
    elapsed += interval;

    // Gradually slow down
    if (elapsed > 1000) interval = 150;
    if (elapsed > 2000) interval = 250;
    if (elapsed > 2800) interval = 400;

    const random1 = Math.floor(Math.random() * 6) + 1;
    const random2 = Math.floor(Math.random() * 6) + 1;
    container.innerHTML = `
      ${createDie(random1, true)}
      ${createDie(random2, true)}
    `;

    if (elapsed >= 3500) {
      clearInterval(animationInterval);

      // Show final result with emphasis
      container.innerHTML = `
        ${createDie(finalDice1, true)}
        ${createDie(finalDice2, true)}
      `;
      title.textContent = `ğŸ‰ é–‹å‡ºï¼š${finalDice1} å’Œ ${finalDice2}`;

      // Hide overlay after showing result
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 1500);
    }
  }, interval);
}

function showDiceResult(dice1, dice2) {
  const resultDiv = document.getElementById('diceResult');
  resultDiv.innerHTML = `
    ${createDie(dice1)}
    ${createDie(dice2)}
  `;
}

function createDie(num, isBig = false) {
  const dots = getDotPositions(num);
  let html = `<div class="die${isBig ? '-big' : ''}">`;
  for (let i = 0; i < 9; i++) {
    html += dots[i] ? '<div class="dot"></div>' : '<div></div>';
  }
  html += '</div>';
  return html;
}

function getDotPositions(num) {
  const patterns = {
    1: [0,0,0, 0,1,0, 0,0,0],
    2: [1,0,0, 0,0,0, 0,0,1],
    3: [1,0,0, 0,1,0, 0,0,1],
    4: [1,0,1, 0,0,0, 1,0,1],
    5: [1,0,1, 0,1,0, 1,0,1],
    6: [1,0,1, 1,0,1, 1,0,1]
  };
  return patterns[num];
}

async function nextRound() {
  // Only update Firebase, let updateGameUI handle the rest
  await currentRoomRef.update({
    gameState: 'betting',
    timer: 120,
    diceResult: null,
    bets: {}
  });

  // Hide next round button for banker
  document.getElementById('nextRoundBtn').style.display = 'none';

  if (isBanker) {
    document.getElementById('endBettingBtn').style.display = 'block';
  }
}

function updateGameUI(data) {
  gameState = data.gameState || 'waiting';

  // Update bets on table
  if (data.bets) {
    for (let i = 1; i <= 6; i++) {
      const betsList = document.getElementById('betsList' + i);
      if (betsList) {
        const betsForNumber = [];
        Object.entries(data.bets).forEach(([playerName, playerBets]) => {
          if (typeof playerBets === 'object' && playerBets[i]) {
            betsForNumber.push({
              player: playerName,
              amount: playerBets[i]
            });
          }
        });

        betsList.innerHTML = betsForNumber.map(bet =>
          `<div class="bet-item">
            <span class="bet-player">${bet.player}</span>
            <span class="bet-amount">\$${bet.amount}</span>
          </div>`
        ).join('');
      }
    }
  }

  // Handle betting state for all players
  if (data.gameState === 'betting') {
    // Reset for new round
    selectedChip = null;
    myBets = {};
    document.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
    updateMyBetsDisplay();

    // Clear previous results
    document.getElementById('diceResult').innerHTML = '';
    document.getElementById('resultPanel').style.display = 'none';

    // Clear winner highlights
    for (let i = 1; i <= 6; i++) {
      document.getElementById('betSpot' + i)?.classList.remove('winner');
    }

    // Show betting panel for players
    if (!isBanker) {
      document.getElementById('bettingPanel').style.display = 'block';
    }

    // Start timer for all
    if (!timerInterval) {
      startTimer(data.timer || 120);
    }
  }

  // Update game state
  if (data.gameState === 'rolling') {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    if (isBanker) {
      document.getElementById('endBettingBtn').style.display = 'none';
      document.getElementById('rollDiceBtn').style.display = 'block';
    } else {
      // Show waiting message for players
      document.getElementById('timerLabel').textContent = 'ç­‰å¾…é–‹ç';
      document.getElementById('timerValue').textContent = 'ğŸ²';
      document.getElementById('timerValue').style.fontSize = '3rem';
    }
  }

  // Rolling animation (all players see this)
  if (data.gameState === 'rollingAnimation' && data.diceResult) {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    // Hide banker controls during animation
    document.getElementById('rollDiceBtn').style.display = 'none';

    // Show animation for all players
    showDiceAnimation(data.diceResult[0], data.diceResult[1]);
  }

  if (data.gameState === 'result' && data.diceResult) {
    showDiceResult(data.diceResult[0], data.diceResult[1]);
    showResults(data);
    highlightWinningSpots(data.diceResult);

    // Reset timer display
    document.getElementById('timerLabel').textContent = 'çµæœå…¬å¸ƒ';
    document.getElementById('timerValue').textContent = 'âœ…';
    document.getElementById('timerValue').style.fontSize = '2.5rem';

    if (isBanker) {
      document.getElementById('nextRoundBtn').style.display = 'block';
    }
  }
}

function highlightWinningSpots(diceResult) {
  for (let i = 1; i <= 6; i++) {
    const spot = document.getElementById('betSpot' + i);
    if (spot) {
      if (diceResult.includes(i)) {
        spot.classList.add('winner');
      } else {
        spot.classList.remove('winner');
      }
    }
  }
}

function showResults(data) {
  const resultPanel = document.getElementById('resultPanel');
  const resultList = document.getElementById('resultList');

  if (!data.bets || !data.diceResult) return;

  const results = [];

  Object.entries(data.bets).forEach(([playerName, playerBets]) => {
    if (typeof playerBets !== 'object') return;

    let totalWin = 0;
    let totalLose = 0;

    Object.entries(playerBets).forEach(([number, amount]) => {
      const matchCount = data.diceResult.filter(d => d === parseInt(number)).length;
      if (matchCount > 0) {
        totalWin += amount * matchCount;
      } else {
        totalLose += amount;
      }
    });

    const netAmount = totalWin - totalLose;
    const outcome = netAmount > 0 ? 'win' : (netAmount < 0 ? 'lose' : 'lose');
    const text = netAmount > 0
      ? `è´ \$${netAmount}`
      : (netAmount < 0 ? `è¼¸ \$${Math.abs(netAmount)}` : 'æ‰“å¹³');

    results.push({ player: playerName, outcome, text });
  });

  resultList.innerHTML = results.map(r =>
    `<div class="result-item">
      <span class="result-player">${r.player}</span>
      <span class="result-outcome ${r.outcome}">${r.text}</span>
    </div>`
  ).join('');

  resultPanel.style.display = 'block';
}

function backToLogin() {
  if (currentRoomRef) {
    if (isBanker) {
      currentRoomRef.remove();
    } else {
      currentRoomRef.child('players').child(myName).remove();
    }
    currentRoomRef.off();
  }

  location.reload();
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}
</script>

</body>
</html>
