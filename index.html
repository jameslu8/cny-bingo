<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ§§ ç›§æ°é›†åœ˜é¦¬ä¸Šæœ‰éŒ¢ éŠæˆ²ä¸­å¿ƒ</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=ZCOOL+KuaiLe&display=swap');

:root {
  --red: #C41E1E;
  --red-dark: #7A0000;
  --red-deep: #520000;
  --gold: #F0C040;
  --gold-bright: #FFD700;
  --gold-dim: #B8860B;
  --cream: #FFF8E8;
  --cream-dark: #F5E6C8;
  --ink: #1A0505;
  --glass: rgba(0,0,0,0.25);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans TC', sans-serif;
  min-height: 100vh;
  background:
    radial-gradient(ellipse at 30% 20%, rgba(240,192,64,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 80%, rgba(196,30,30,0.15) 0%, transparent 40%),
    linear-gradient(175deg, #520000 0%, #7A0000 35%, #520000 70%, #3A0000 100%);
  color: var(--cream);
  -webkit-tap-highlight-color: transparent;
  position: relative;
  overflow-x: hidden;
}

/* Particles */
.particles { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
.particle {
  position: absolute; opacity: 0.2;
  animation: drift linear infinite;
}
@keyframes drift {
  0% { transform: translateY(105vh) rotate(0deg); opacity: 0; }
  8% { opacity: 0.25; }
  85% { opacity: 0.25; }
  100% { transform: translateY(-5vh) rotate(30deg) scale(0.7); opacity: 0; }
}

/* Screens */
.screen { display: none; position: relative; z-index: 1; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }

/* Header */
.header { text-align: center; margin-bottom: 30px; animation: fadeIn 0.8s ease-out; }
.header-emoji { font-size: 4rem; margin-bottom: 10px; animation: bounce 2s ease-in-out infinite; }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.title {
  font-family: 'ZCOOL KuaiLe', cursive; font-size: 2.5rem; color: var(--gold);
  text-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-bottom: 8px;
  background: linear-gradient(90deg, var(--gold), #FFF8E8, var(--gold-bright), var(--gold));
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 3s linear infinite;
}
@keyframes shimmer { to { background-position: 200% center; } }
.subtitle { font-size: 1rem; color: var(--cream); opacity: 0.8; }

/* Login card */
.login-card {
  background: linear-gradient(160deg, rgba(255,248,232,0.96), rgba(245,230,200,0.93));
  border: 3px solid var(--gold);
  border-radius: 24px;
  padding: 36px 28px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 8px 60px rgba(0,0,0,0.4), 0 0 80px rgba(240,192,64,0.1);
  color: var(--ink);
  animation: cardUp 0.7s cubic-bezier(0.175,0.885,0.32,1.275);
}
@keyframes cardUp { from { opacity:0; transform: translateY(40px) scale(0.9); } to { opacity:1; transform: translateY(0) scale(1); } }

.input-group { margin-bottom: 14px; }
.input-group label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--red-dark); margin-bottom: 5px; opacity: 0.8; }
.input-group input {
  width: 100%; padding: 13px 15px;
  border: 2px solid rgba(196,30,30,0.18);
  border-radius: 13px;
  font-family: 'Noto Sans TC', sans-serif; font-size: 1.05rem;
  background: rgba(255,255,255,0.7); color: var(--ink); outline: none;
  transition: border-color 0.2s;
}
.input-group input:focus { border-color: var(--gold); }
.input-group input::placeholder { color: #bbb; }

.login-btn {
  width: 100%; padding: 15px;
  background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
  color: var(--gold-bright); border: 2px solid var(--gold);
  border-radius: 16px;
  font-family: 'ZCOOL KuaiLe', cursive; font-size: 1.25rem;
  cursor: pointer; transition: all 0.3s cubic-bezier(0.175,0.885,0.32,1.275); letter-spacing: 2px;
  box-shadow: 0 4px 20px rgba(122,0,0,0.3); margin-top: 6px;
  position: relative; overflow: hidden;
}
.login-btn::after {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,215,0,0.4) 0%, transparent 60%);
  opacity: 0; transition: opacity 0.3s;
}
.login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(122,0,0,0.4); }
.login-btn:hover::after { opacity: 1; }
.login-btn:active { transform: scale(0.95); }
.login-btn.secondary {
  background: rgba(255,255,255,0.6);
  color: var(--red-dark);
  font-size: 1rem;
  padding: 12px;
  box-shadow: 0 2px 12px rgba(122,0,0,0.15);
}

/* Reconnect banner */
.reconnect-banner {
  background: rgba(76,175,80,0.15);
  border: 2px solid #4CAF50;
  border-radius: 16px;
  padding: 14px 18px;
  margin-bottom: 16px;
  max-width: 400px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  animation: cardUp 0.5s ease-out;
}
.reconnect-text { font-size: 0.85rem; color: var(--cream); }
.reconnect-text strong { color: var(--gold); }
.reconnect-btn {
  padding: 8px 16px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  white-space: nowrap;
}
.reconnect-dismiss {
  padding: 4px 8px;
  background: none;
  border: none;
  color: var(--cream);
  opacity: 0.5;
  cursor: pointer;
  font-size: 1.2rem;
}

/* Lobby screen */
#lobbyScreen { justify-content: flex-start; padding-top: 30px; }

.lobby-container { max-width: 500px; width: 100%; }

.lobby-header { text-align: center; margin-bottom: 20px; }

.lobby-room-code {
  background: rgba(0,0,0,0.3);
  border: 2px solid var(--gold);
  border-radius: 20px;
  padding: 16px;
  margin-bottom: 20px;
  text-align: center;
  backdrop-filter: blur(8px);
}
.lobby-room-label { font-size: 0.75rem; color: var(--gold-dim); letter-spacing: 2px; font-weight: 700; }
.lobby-room-number {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 3rem;
  color: var(--gold);
  letter-spacing: 10px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3), 0 0 40px rgba(255,215,0,0.3);
  animation: roomCodeGlow 2s ease-in-out infinite alternate;
}
@keyframes roomCodeGlow {
  from { text-shadow: 0 2px 10px rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.2); }
  to { text-shadow: 0 2px 10px rgba(0,0,0,0.3), 0 0 50px rgba(255,215,0,0.5), 0 0 80px rgba(255,215,0,0.2); }
}

.player-list-section {
  background: rgba(0,0,0,0.3);
  border: 1.5px solid rgba(240,192,64,0.2);
  border-radius: 18px;
  padding: 16px;
  margin-bottom: 24px;
  backdrop-filter: blur(8px);
}
.player-list-title {
  font-size: 0.75rem; color: var(--gold-dim); font-weight: 700;
  letter-spacing: 1px; margin-bottom: 10px; text-align: center;
}
.player-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.player-chip {
  padding: 8px 16px;
  background: var(--glass);
  border: 1.5px solid rgba(240,192,64,0.25);
  border-radius: 20px;
  color: var(--cream);
  font-size: 0.85rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  animation: chipPop 0.4s cubic-bezier(0.175,0.885,0.32,1.275) both;
  transition: all 0.3s;
}
.player-chip:hover { transform: scale(1.08); border-color: var(--gold); }
@keyframes chipPop { from { opacity:0; transform: scale(0); } to { opacity:1; transform: scale(1); } }
.player-chip.host { border-color: var(--gold); color: var(--gold); }
.player-chip .crown { font-size: 0.7rem; }

/* Game cards */
.game-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}
.game-card:nth-child(1) { animation: cardEntrance 0.6s cubic-bezier(0.175,0.885,0.32,1.275) 0.1s both; }
.game-card:nth-child(2) { animation: cardEntrance 0.6s cubic-bezier(0.175,0.885,0.32,1.275) 0.25s both; }
.game-card:nth-child(3) { animation: cardEntrance 0.6s cubic-bezier(0.175,0.885,0.32,1.275) 0.4s both; }
@keyframes cardEntrance { from { opacity:0; transform: translateY(40px) scale(0.85) rotateX(10deg); } to { opacity:1; transform: translateY(0) scale(1) rotateX(0); } }

.game-card {
  background: linear-gradient(160deg, rgba(255,248,232,0.96), rgba(245,230,200,0.93));
  border: 3px solid var(--gold);
  border-radius: 24px;
  padding: 28px 24px;
  box-shadow: 0 8px 60px rgba(0,0,0,0.4), 0 0 80px rgba(240,192,64,0.1);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  text-decoration: none;
  display: block;
  position: relative;
  overflow: hidden;
  transform-style: preserve-3d;
  perspective: 800px;
}
.game-card::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(105deg, transparent 40%, rgba(255,215,0,0.15) 45%, rgba(255,215,0,0.3) 50%, rgba(255,215,0,0.15) 55%, transparent 60%);
  transform: translateX(-100%);
  transition: none;
}
.game-card:hover::before {
  animation: cardShine 0.6s ease-out forwards;
}
@keyframes cardShine { to { transform: translateX(100%); } }
.game-card:hover {
  transform: translateY(-8px) rotateX(2deg);
  box-shadow: 0 16px 80px rgba(0,0,0,0.5), 0 0 120px rgba(240,192,64,0.25);
  border-color: var(--gold-bright);
}
.game-card:active { transform: translateY(-2px) scale(0.97); }

.game-icon { font-size: 3rem; text-align: center; margin-bottom: 12px; animation: iconFloat 3s ease-in-out infinite; }
@keyframes iconFloat { 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-6px) scale(1.08); } }
.game-title {
  font-family: 'ZCOOL KuaiLe', cursive;
  font-size: 1.6rem;
  color: var(--red);
  text-align: center;
  margin-bottom: 8px;
}
.game-desc {
  font-size: 0.85rem;
  color: var(--red-dark);
  opacity: 0.7;
  text-align: center;
  line-height: 1.6;
}

.host-hint {
  text-align: center;
  font-size: 0.85rem;
  color: var(--gold-dim);
  margin-top: 16px;
}

.lobby-footer { text-align: center; margin-top: 24px; }
.lobby-leave-btn {
  padding: 10px 24px;
  background: rgba(255,255,255,0.15);
  border: 1.5px solid rgba(255,255,255,0.3);
  border-radius: 20px;
  color: var(--cream);
  opacity: 0.7;
  font-family: 'Noto Sans TC', sans-serif;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}
.lobby-leave-btn:hover { opacity: 1; background: rgba(255,255,255,0.25); }

/* Toast */
.toast {
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
  background: var(--gold); color: var(--red-deep);
  padding: 10px 22px; border-radius: 30px; font-weight: 700; font-size: 0.88rem;
  z-index: 300; opacity: 0; transition: all 0.3s; pointer-events: none; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.offline-banner {
  position: fixed; top: 0; left: 0; right: 0;
  background: #e74c3c; color: #fff; text-align: center;
  padding: 8px; font-size: 0.85rem; font-weight: 700;
  z-index: 9999; display: none;
}
.offline-banner.show { display: block; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

@media (min-width: 600px) {
  .game-cards { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<!-- ======== WELCOME ======== -->
<div class="screen active" id="welcomeScreen">
  <div class="header">
    <div class="header-emoji">ğŸ®ğŸ§§ğŸ®</div>
    <h1 class="title">ç›§æ°é›†åœ˜é¦¬ä¸Šæœ‰éŒ¢</h1>
    <p class="subtitle">éŠæˆ²ä¸­å¿ƒ</p>
  </div>

  <div id="reconnectBanner"></div>

  <div class="login-card">
    <div id="createPanel">
      <div class="input-group">
        <label>ğŸ‘¤ ä½ çš„åå­—</label>
        <input type="text" id="hostNameInput" placeholder="ä¾‹ï¼šçˆ¸çˆ¸" autocomplete="off">
      </div>
      <div style="text-align:center; margin: 10px 0;">
        <button class="login-btn" onclick="createLobby()">ğŸŠ å»ºç«‹æˆ¿é–“</button>
        <button class="login-btn secondary" onclick="showJoinPanel()">ğŸšª åŠ å…¥æˆ¿é–“</button>
      </div>
      <div style="font-size:0.72rem; color: var(--red-dark); opacity:0.5; text-align:center; margin-top:12px;">
        å»ºç«‹æˆ¿é–“å¾Œï¼Œåˆ†äº«æˆ¿é–“ç¢¼çµ¦å®¶äººä¸€èµ·ç©
      </div>
    </div>

    <div id="joinPanel" style="display:none;">
      <div class="input-group">
        <label>ğŸ¯ æˆ¿é–“ç¢¼</label>
        <input type="text" id="roomCodeInput" placeholder="è¼¸å…¥ 4 ä½æ•¸æˆ¿é–“ç¢¼" autocomplete="off" maxlength="4" inputmode="numeric" pattern="[0-9]*">
      </div>
      <div class="input-group">
        <label>ğŸ‘¤ ä½ çš„åå­—</label>
        <input type="text" id="playerNameInput" placeholder="ä¾‹ï¼šåª½åª½" autocomplete="off">
      </div>
      <div style="text-align:center; margin: 10px 0;">
        <button class="login-btn" onclick="joinLobby()">ğŸš€ åŠ å…¥æˆ¿é–“</button>
        <button class="login-btn secondary" onclick="showCreatePanel()">â† è¿”å›</button>
      </div>
    </div>
  </div>
</div>

<!-- ======== LOBBY ======== -->
<div class="screen" id="lobbyScreen">
  <div class="lobby-container">
    <div class="lobby-header">
      <div class="header-emoji" style="font-size:3rem;">ğŸ®ğŸ§§ğŸ®</div>
      <h1 class="title" style="font-size:2rem;">ç›§æ°é›†åœ˜é¦¬ä¸Šæœ‰éŒ¢</h1>
    </div>

    <div class="lobby-room-code">
      <div class="lobby-room-label">æˆ¿é–“ç¢¼</div>
      <div class="lobby-room-number" id="lobbyRoomCode"></div>
    </div>

    <div class="player-list-section">
      <div class="player-list-title">ğŸŠ ç©å®¶</div>
      <div class="player-list" id="playerList"></div>
    </div>

    <div id="gameSelectionArea">
      <div class="game-cards">
        <div class="game-card" onclick="startGame('bingo')" id="bingoCard">
          <div class="game-icon">ğŸ´</div>
          <div class="game-title">è³“æœå¤§æ¨‚é€</div>
          <div class="game-desc">
            6x6 è³“æœç‰Œï¼Œè¼ªæµé¸ç‰Œ<br>
            å…ˆé€£æ»¿ 5 æ¢ç·šå°±è´ï¼
          </div>
        </div>

        <div class="game-card" onclick="startGame('dice')" id="diceCard">
          <div class="game-icon">ğŸ²</div>
          <div class="game-title">éª°å­æ–æ–æ¨‚</div>
          <div class="game-desc">
            æŠ¼ 1-6 é»æ•¸ï¼Œä¸‹æ³¨ 10-50<br>
            ä¸­ä¸€é¡†è³º 1 å€ï¼Œå…©é¡†è³º 2 å€ï¼
          </div>
        </div>

        <div class="game-card" onclick="startGame('hongbao')" id="hongbaoCard">
          <div class="game-icon">ğŸ§§</div>
          <div class="game-title">æ¶ç´…åŒ…</div>
          <div class="game-desc">
            ä¸»æŒäººç™¼ç´…åŒ…ï¼Œå¤§å®¶ä¸€èµ·æ¶<br>
            æ‰‹æ°£æœ€ä½³æ˜¯èª°ï¼Ÿ
          </div>
        </div>
      </div>
      <div class="host-hint" id="hostHint"></div>
    </div>

    <div class="lobby-footer">
      <button class="lobby-leave-btn" onclick="leaveLobby()">é›¢é–‹æˆ¿é–“</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="offline-banner" id="offlineBanner">âš ï¸ ç¶²è·¯å·²æ–·ç·šï¼Œè«‹æª¢æŸ¥é€£ç·š</div>

<script>
// =========================================================
// FIREBASE CONFIG
// =========================================================
const firebaseConfig = {
  apiKey: "AIzaSyCbAlw-_oXbZ1XRujDfrvXGUfNBsVmzONk",
  authDomain: "cny-bingo.firebaseapp.com",
  databaseURL: "https://cny-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cny-bingo",
  storageBucket: "cny-bingo.firebasestorage.app",
  messagingSenderId: "483196851206",
  appId: "1:483196851206:web:891fad23ced5450c939f87"
};

let db = null;
let lobbyRef = null;
let lobbyCode = null;
let myName = '';
let isHost = false;

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('ğŸ”¥ Firebase å·²å•Ÿç”¨');

  // Monitor connection status
  db.ref('.info/connected').on('value', (snap) => {
    const banner = document.getElementById('offlineBanner');
    if (snap.val() === true) {
      banner.classList.remove('show');
    } else {
      banner.classList.add('show');
    }
  });
} catch (e) {
  console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', e);
}

// =========================================================
// SESSION PERSISTENCE (localStorage)
// =========================================================
const SESSION_KEY = 'cny-lobby-session';
const SESSION_TTL = 2 * 60 * 60 * 1000; // 2 hours

function saveSession() {
  localStorage.setItem(SESSION_KEY, JSON.stringify({
    lobbyCode, playerName: myName, isHost, savedAt: Date.now()
  }));
}

function loadSession() {
  try {
    const data = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (data && Date.now() - data.savedAt < SESSION_TTL) return data;
  } catch (e) {}
  return null;
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
}

// =========================================================
// UI HELPERS
// =========================================================
function showJoinPanel() {
  document.getElementById('createPanel').style.display = 'none';
  document.getElementById('joinPanel').style.display = 'block';
}

function showCreatePanel() {
  document.getElementById('joinPanel').style.display = 'none';
  document.getElementById('createPanel').style.display = 'block';
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =========================================================
// ROOM CODE
// =========================================================
function generateRoomCode() {
  return String(Math.floor(1000 + Math.random() * 9000));
}

// =========================================================
// LOBBY MANAGEMENT
// =========================================================
async function createLobby() {
  const name = document.getElementById('hostNameInput').value.trim();
  if (!name) { showToast('è«‹è¼¸å…¥ä½ çš„åå­—'); return; }
  if (!db) { showToast('Firebase é€£ç·šå¤±æ•—'); return; }

  const btn = event && event.target;
  if (btn) { btn.disabled = true; btn.textContent = 'å»ºç«‹ä¸­...'; }

  try {
    lobbyCode = generateRoomCode();
    lobbyRef = db.ref('lobbies/' + lobbyCode);
    myName = name;
    isHost = true;

    await lobbyRef.set({
      host: name,
      players: { [name]: { name, joinedAt: Date.now() } },
      currentGame: null,
      createdAt: Date.now()
    });

    // Auto-remove room if host disconnects
    lobbyRef.onDisconnect().remove();

    saveSession();
    listenToLobby();
    showLobby();
    showToast('æˆ¿é–“å·²å»ºç«‹ï¼');
  } catch (e) {
    console.error('å»ºç«‹æˆ¿é–“å¤±æ•—:', e);
    showToast('å»ºç«‹æˆ¿é–“å¤±æ•—ï¼Œè«‹é‡è©¦');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'å»ºç«‹æˆ¿é–“'; }
  }
}

async function joinLobby() {
  const code = document.getElementById('roomCodeInput').value.trim();
  const name = document.getElementById('playerNameInput').value.trim();
  if (!code || code.length !== 4) { showToast('è«‹è¼¸å…¥ 4 ä½æ•¸æˆ¿é–“ç¢¼'); return; }
  if (!name) { showToast('è«‹è¼¸å…¥ä½ çš„åå­—'); return; }
  if (!db) { showToast('Firebase é€£ç·šå¤±æ•—'); return; }

  const btn = event && event.target;
  if (btn) { btn.disabled = true; btn.textContent = 'åŠ å…¥ä¸­...'; }

  try {
    lobbyCode = code;
    lobbyRef = db.ref('lobbies/' + lobbyCode);
    myName = name;
    isHost = false;

    const snapshot = await lobbyRef.once('value');
    if (!snapshot.exists()) { showToast('æˆ¿é–“ä¸å­˜åœ¨'); return; }

    const data = snapshot.val();
    if (data.players && data.players[name]) { showToast('åå­—å·²è¢«ä½¿ç”¨'); return; }

    await lobbyRef.child('players').child(name).set({ name, joinedAt: Date.now() });

    // Auto-remove player if disconnected
    lobbyRef.child('players').child(name).onDisconnect().remove();

    saveSession();
    listenToLobby();
    showLobby();
    showToast('å·²åŠ å…¥æˆ¿é–“ï¼');
  } catch (e) {
    console.error('åŠ å…¥æˆ¿é–“å¤±æ•—:', e);
    showToast('åŠ å…¥æˆ¿é–“å¤±æ•—ï¼Œè«‹é‡è©¦');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'åŠ å…¥æˆ¿é–“'; }
  }
}

async function rejoinLobby(session) {
  if (!session || !db) return;

  lobbyCode = session.lobbyCode;
  myName = session.playerName;
  isHost = session.isHost;
  lobbyRef = db.ref('lobbies/' + lobbyCode);

  const snapshot = await lobbyRef.once('value');
  if (!snapshot.exists()) {
    showToast('æˆ¿é–“å·²ä¸å­˜åœ¨');
    clearSession();
    return;
  }

  const data = snapshot.val();

  // Re-add player if not in list
  if (!data.players || !data.players[myName]) {
    await lobbyRef.child('players').child(myName).set({ name: myName, joinedAt: Date.now() });
  }

  // Check if still host
  isHost = data.host === myName;

  saveSession();
  listenToLobby();
  showLobby();
  showToast('å·²é‡æ–°åŠ å…¥æˆ¿é–“ï¼');
}

function showLobby() {
  showScreen('lobbyScreen');
  document.getElementById('lobbyRoomCode').textContent = lobbyCode;
}

function listenToLobby() {
  if (!lobbyRef) return;

  lobbyRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      // Room was deleted
      showToast('æˆ¿é–“å·²é—œé–‰');
      clearSession();
      if (lobbyRef) lobbyRef.off();
      lobbyRef = null;
      showScreen('welcomeScreen');
      return;
    }

    // Update player list
    const players = data.players || {};
    const playerNames = Object.keys(players);
    const listEl = document.getElementById('playerList');
    listEl.innerHTML = playerNames.map(name => {
      const isHostPlayer = name === data.host;
      return `<div class="player-chip ${isHostPlayer ? 'host' : ''}">
        ${isHostPlayer ? '<span class="crown">ğŸ‘‘</span>' : ''}${name}
      </div>`;
    }).join('');

    // Update hint
    const hint = document.getElementById('hostHint');
    if (isHost) {
      hint.textContent = 'ğŸ‘† é¸æ“‡ä¸€å€‹éŠæˆ²é–‹å§‹ç©ï¼ï¼ˆ' + playerNames.length + ' ä½ç©å®¶ï¼‰';
    } else {
      hint.textContent = 'â³ ç­‰å¾… ' + data.host + ' é¸æ“‡éŠæˆ²...';
    }

    // Check if a game was started
    if (data.currentGame) {
      navigateToGame(data.currentGame);
    }
  }, (error) => {
    console.error('å¤§å»³é€£ç·šéŒ¯èª¤:', error);
    showToast('é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
  });
}

function navigateToGame(game) {
  // Detach listener before navigating
  if (lobbyRef) lobbyRef.off();

  const params = new URLSearchParams({
    lobby: lobbyCode,
    name: myName,
    host: isHost ? '1' : '0'
  });

  if (game === 'bingo') {
    window.location.href = 'bingo.html?' + params.toString();
  } else if (game === 'dice') {
    window.location.href = 'dice.html?' + params.toString();
  } else if (game === 'hongbao') {
    window.location.href = 'hongbao.html?' + params.toString();
  }
}

async function startGame(game) {
  if (!isHost) {
    showToast('åªæœ‰ä¸»æŒäººå¯ä»¥é¸æ“‡éŠæˆ²');
    return;
  }

  await lobbyRef.update({ currentGame: game });
  // The listener will detect this change and call navigateToGame
}

async function leaveLobby() {
  if (lobbyRef) {
    lobbyRef.off();
    if (isHost) {
      await lobbyRef.remove();
    } else {
      await lobbyRef.child('players').child(myName).remove();
    }
  }
  clearSession();
  lobbyRef = null;
  lobbyCode = null;
  showScreen('welcomeScreen');
}

// =========================================================
// INIT
// =========================================================
(function init() {
  // Check URL params (returning from a game)
  const params = new URLSearchParams(window.location.search);
  const lobbyParam = params.get('lobby');
  const nameParam = params.get('name');
  const hostParam = params.get('host');

  if (lobbyParam && nameParam && db) {
    lobbyCode = lobbyParam;
    myName = nameParam;
    isHost = hostParam === '1';
    lobbyRef = db.ref('lobbies/' + lobbyCode);

    // Clean URL
    window.history.replaceState({}, '', window.location.pathname);

    // Reset currentGame so lobby is back in waiting state
    if (isHost) {
      lobbyRef.update({ currentGame: null });
    }

    // Re-add self and listen
    lobbyRef.child('players').child(myName).set({ name: myName, joinedAt: Date.now() }).then(() => {
      saveSession();
      listenToLobby();
      showLobby();
    });
    return;
  }

  // Check localStorage for saved session
  const session = loadSession();
  if (session && db) {
    const banner = document.getElementById('reconnectBanner');
    banner.innerHTML = `
      <div class="reconnect-banner">
        <div class="reconnect-text">ä¹‹å‰åœ¨æˆ¿é–“ <strong>${session.lobbyCode}</strong></div>
        <button class="reconnect-btn" onclick="rejoinLobby(loadSession())">é‡æ–°åŠ å…¥</button>
        <button class="reconnect-dismiss" onclick="clearSession(); document.getElementById('reconnectBanner').innerHTML='';">âœ•</button>
      </div>
    `;
  }
})();

// =========================================================
// PARTICLES
// =========================================================
(function() {
  const c = document.getElementById('particles');
  const icons = ['ğŸ®','ğŸ§§','âœ¨','ğŸ’«','ğŸŒ¸','ğŸŠ','ğŸ²','ğŸ´'];
  for (let i = 0; i < 12; i++) {
    const el = document.createElement('div');
    el.className = 'particle';
    el.textContent = icons[Math.floor(Math.random()*icons.length)];
    el.style.left = Math.random()*100+'%';
    el.style.fontSize = (1+Math.random()*1.5)+'rem';
    el.style.animationDuration = (18+Math.random()*20)+'s';
    el.style.animationDelay = (-Math.random()*35)+'s';
    c.appendChild(el);
  }
})();
</script>

</body>
</html>
